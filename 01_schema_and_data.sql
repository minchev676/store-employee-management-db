DROP DATABASE IF EXISTS shop_staff_db;
CREATE DATABASE shop_staff_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE shop_staff_db;

CREATE TABLE departments (
  dept_id INT AUTO_INCREMENT PRIMARY KEY,
  dept_name VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE employees (
  emp_id INT AUTO_INCREMENT PRIMARY KEY,
  first_name VARCHAR(50) NOT NULL,
  last_name VARCHAR(50) NOT NULL,
  phone VARCHAR(20),
  hire_date DATE NOT NULL,
  position VARCHAR(50) NOT NULL,
  hourly_rate DECIMAL(6,2) NOT NULL CHECK (hourly_rate > 0),
  dept_id INT,
  CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
);

CREATE TABLE shifts (
  shift_id INT AUTO_INCREMENT PRIMARY KEY,
  shift_date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  status ENUM('planned','open','closed') NOT NULL DEFAULT 'planned',
  manager_emp_id INT,
  notes VARCHAR(255),
  CONSTRAINT fk_shift_manager FOREIGN KEY (manager_emp_id) REFERENCES employees(emp_id),
  CONSTRAINT chk_shift_time CHECK (end_time > start_time)
);

-- N:M връзка: кой служител работи в коя смяна + реални часове
CREATE TABLE attendance (
  attendance_id INT AUTO_INCREMENT PRIMARY KEY,
  emp_id INT NOT NULL,
  shift_id INT NOT NULL,
  check_in TIME,
  check_out TIME,
  break_minutes INT NOT NULL DEFAULT 0 CHECK (break_minutes >= 0),
  UNIQUE (emp_id, shift_id),
  CONSTRAINT fk_att_emp FOREIGN KEY (emp_id) REFERENCES employees(emp_id),
  CONSTRAINT fk_att_shift FOREIGN KEY (shift_id) REFERENCES shifts(shift_id)
);

-- Продажби по смяна
CREATE TABLE sales (
  sale_id INT AUTO_INCREMENT PRIMARY KEY,
  shift_id INT NOT NULL,
  receipt_no VARCHAR(30) NOT NULL,
  sale_date DATE NOT NULL,
  sale_time TIME NOT NULL,
  amount DECIMAL(10,2) NOT NULL CHECK (amount > 0),
  payment_method ENUM('cash','card') NOT NULL,
  sale_type ENUM('sale','refund') NOT NULL DEFAULT 'sale',
  CONSTRAINT fk_sales_shift FOREIGN KEY (shift_id) REFERENCES shifts(shift_id),
  UNIQUE (receipt_no, sale_date)
);

INSERT INTO departments (dept_name) VALUES
('Каси'),
('Зареждане'),
('Склад'),
('Управление'),
('Охрана'),
('Чистота');

INSERT INTO employees (first_name, last_name, phone, hire_date, position, hourly_rate, dept_id) VALUES
('Иван','Петров','0888123456','2024-03-01','Касиер',9.50,1),
('Мария','Георгиева','0888234567','2023-11-15','Касиер',10.00,1),
('Петър','Димитров','0888345678','2022-06-10','Зареждач',9.00,2),
('Елена','Тодорова','0888456789','2021-02-20','Мениджър смяна',12.50,4),
('Николай','Иванов','0888567890','2024-09-05','Складов работник',9.20,3),
('Силвия','Костова','0888678901','2025-01-12','Касиер',9.80,1),
('Георги','Стоянов','0888789012','2023-04-25','Зареждач',9.10,2),
('Десислава','Николова','0888890123','2022-12-02','Охрана',9.30,5),
('Калоян','Ганчев','0888901234','2025-05-18','Чистач',8.80,6),
('Анна','Михайлова','0888012345','2023-08-09','Складов работник',9.40,3),
('Радослав','Колев','0888023456','2022-01-17','Касиер',10.20,1),
('Виктория','Пенева','0888034567','2021-06-30','Зам.-мениджър',12.00,4);

INSERT INTO shifts (shift_date, start_time, end_time, status, manager_emp_id, notes) VALUES
('2026-01-08','08:00:00','16:00:00','closed',4,'Сутрешна смяна'),
('2026-01-08','16:00:00','23:00:00','closed',4,'Следобедна смяна'),
('2026-01-09','08:00:00','16:00:00','closed',4,'Сутрешна смяна'),
('2026-01-09','16:00:00','23:00:00','closed',12,'Следобедна смяна'),
('2026-01-10','08:00:00','16:00:00','closed',4,'Сутрешна смяна'),
('2026-01-10','16:00:00','23:00:00','closed',12,'Следобедна смяна'),
('2026-01-11','08:00:00','16:00:00','closed',4,'Сутрешна смяна'),
('2026-01-11','16:00:00','23:00:00','closed',4,'Следобедна смяна'),
('2026-01-12','08:00:00','16:00:00','open',4,'Сутрешна смяна'),
('2026-01-12','16:00:00','23:00:00','open',4,'Следобедна смяна'),
('2026-01-13','08:00:00','16:00:00','planned',4,'Сутрешна смяна'),
('2026-01-13','16:00:00','23:00:00','planned',12,'Следобедна смяна');

INSERT INTO attendance (emp_id, shift_id, check_in, check_out, break_minutes) VALUES
-- 08.01
(1,1,'08:02:00','16:00:00',30),
(2,1,'08:00:00','15:50:00',20),
(3,1,'08:10:00','16:05:00',30),
(5,1,'08:00:00','16:00:00',30),
(8,1,'08:00:00','16:00:00',20),
(11,1,'08:05:00','16:00:00',30),
(6,2,'16:02:00','23:00:00',20),
(2,2,'16:00:00','23:10:00',30),
(7,2,'16:05:00','23:00:00',30),
(9,2,'16:00:00','23:00:00',20),
(8,2,'16:00:00','23:00:00',20),
-- 09.01
(1,3,'08:00:00','16:00:00',30),
(6,3,'08:03:00','16:00:00',20),
(3,3,'08:05:00','16:00:00',30),
(10,3,'08:00:00','16:00:00',30),
(11,4,'16:00:00','23:00:00',30),
(2,4,'16:02:00','23:05:00',30),
(7,4,'16:00:00','23:00:00',30),
(8,4,'16:00:00','23:00:00',20),
-- 10.01
(5,5,'08:00:00','16:00:00',30),
(3,5,'08:10:00','16:00:00',30),
(1,5,'08:01:00','16:00:00',30),
(6,6,'16:00:00','23:00:00',30),
(2,6,'16:00:00','23:00:00',30),
(7,6,'16:00:00','23:00:00',30),
-- 11.01
(10,7,'08:00:00','16:00:00',30),
(5,7,'08:05:00','16:00:00',30),
(1,7,'08:00:00','16:00:00',30),
(11,8,'16:00:00','23:00:00',30),
(6,8,'16:02:00','23:00:00',20),
(2,8,'16:00:00','23:00:00',30),
-- 12.01
(1,9,'08:02:00','16:00:00',30),
(2,9,'08:00:00','15:55:00',20),
(3,9,'08:10:00','16:05:00',30),
(6,10,'16:05:00','23:00:00',20),
(2,10,'16:00:00','23:10:00',30),
(7,10,'16:00:00','23:00:00',30);

-- Продажби
INSERT INTO sales (shift_id, receipt_no, sale_date, sale_time, amount, payment_method, sale_type) VALUES
-- 08.01
(1,'R0801','2026-01-08','09:15:00',18.40,'card','sale'),
(1,'R0802','2026-01-08','10:05:00',42.99,'cash','sale'),
(1,'R0803','2026-01-08','11:22:00',9.80,'card','sale'),
(1,'R0804','2026-01-08','12:47:00',25.10,'card','sale'),
(1,'R0805','2026-01-08','14:33:00',61.70,'cash','sale'),
-- 08.01
(2,'R0811','2026-01-08','17:40:00',55.20,'card','sale'),
(2,'R0812','2026-01-08','18:10:00',12.00,'cash','sale'),
(2,'R0813','2026-01-08','19:05:00',7.50,'card','sale'),
(2,'R0814','2026-01-08','20:22:00',33.90,'card','sale'),
(2,'R0815','2026-01-08','21:55:00',14.30,'cash','sale'),
-- 09.01
(3,'R0901','2026-01-09','09:05:00',28.40,'card','sale'),
(3,'R0902','2026-01-09','10:44:00',19.99,'cash','sale'),
(3,'R0903','2026-01-09','13:12:00',6.70,'card','sale'),
(3,'R0904','2026-01-09','15:01:00',44.00,'card','sale'),
-- 09.01
(4,'R0911','2026-01-09','16:35:00',22.20,'cash','sale'),
(4,'R0912','2026-01-09','17:50:00',49.90,'card','sale'),
(4,'R0913','2026-01-09','19:20:00',13.40,'card','sale'),
(4,'R0914','2026-01-09','21:10:00',75.00,'card','sale'),
-- 10.01
(5,'R1001','2026-01-10','08:55:00',10.20,'cash','sale'),
(5,'R1002','2026-01-10','11:30:00',52.60,'card','sale'),
(5,'R1003','2026-01-10','14:15:00',31.10,'card','sale'),
-- 10.01
(6,'R1011','2026-01-10','16:20:00',27.80,'cash','sale'),
(6,'R1012','2026-01-10','18:05:00',8.90,'card','sale'),
(6,'R1013','2026-01-10','20:40:00',66.30,'card','sale'),
-- 11.01
(7,'R1101','2026-01-11','09:10:00',41.20,'card','sale'),
(7,'R1102','2026-01-11','12:00:00',16.50,'cash','sale'),
(7,'R1103','2026-01-11','15:45:00',29.99,'card','sale'),
-- 11.01
(8,'R1111','2026-01-11','17:05:00',11.00,'cash','sale'),
(8,'R1112','2026-01-11','19:25:00',58.75,'card','sale'),
(8,'R1113','2026-01-11','21:55:00',9.99,'card','sale'),
-- 12.01 
(9,'R1201','2026-01-12','09:20:00',17.30,'card','sale'),
(9,'R1202','2026-01-12','10:50:00',24.00,'cash','sale'),
(9,'R1203','2026-01-12','13:05:00',63.40,'card','sale'),
-- 12.01
(10,'R1211','2026-01-12','16:40:00',35.60,'card','sale'),
(10,'R1212','2026-01-12','18:30:00',12.20,'cash','sale'),
(10,'R1213','2026-01-12','21:10:00',48.90,'card','sale'),
-- пример за refund
(10,'R1212-REF','2026-01-12','18:45:00',12.20,'cash','refund');
